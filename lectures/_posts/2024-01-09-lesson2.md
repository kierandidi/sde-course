---
layout: post
title: Lesson 2 - SDEs and how to condition them
image: /assets/img/lessons/brownian_motion.png
accent_image: 
  background: url('/assets/img/sampling_space.png') center/cover
  overlay: false
accent_color: '#ccc'
theme_color: '#ccc'
description: >
  How to reverse and condition SDEs
invert_sidebar: true
---

# Lesson 2 - SDEs and how to condition them

### Optional reading for this lesson
- - [Särkkä & Solin - Applied Stochastic Differential Equations](https://github.com/AaltoML/SDE), chapter 5, 6 and 7
- [Derivation FP Equation for some SDEs (Video)](https://www.youtube.com/watch?v=MmcgT6-lBoY)

### [Slides](/assets/slides/r255-l2.pdf)

#### Video (soon)

In this lecture we continue with our discussion of SDEs and how to manipulate them. Specifically, we will look how we can describe the evolution of the probability density of an SDE via the Fokker-PLanck Equation, how we can reverse SDEs via Nelsons Duality Formula and how we can condition SDEs via Doob's h-transform.

* toc
{:toc}

## 1. The Fokker-Planck Equation 

In the first lecture we saw that while the solution of an ODE is just a deterministic function, the solution of an SDE is a stochastic process. We can describe this process by the SDE solution, but as a stocastic process it also has properties like a probability distribution and statistics. In this first part, we will therefore look at the Fokker-Planck Equation (FPE), which describes the evolution of the probability density of an SDE and look at the FPE for some common SDEs.

The FPE has [many names](https://en.wikipedia.org/wiki/Fokker%E2%80%93Planck_equation) depending on the field you work in. In physics it is often called the [Smoluchowski equation](https://en.wikipedia.org/wiki/Smoluchowski_equation), in probability theory it is called the [Kolmogorov forward equation](https://en.wikipedia.org/wiki/Kolmogorov_forward_equation) and in statistics it is called the [Fokker-Planck-Kolmogorov equation](https://en.wikipedia.org/wiki/Fokker%E2%80%93Planck_equation#Fokker%E2%80%93Planck%E2%80%93Kolmogorov_equation). In this lecture we will use the term Fokker-Planck Equation (FPE).

> Definition: The Fokker-Planck Equation (FPE) describes the evolution of the probability density of an SDE. For a general SDE of the form $$dX_t = \mu(X_t, t)dt + \sigma(X_t, t)dW_t$$,  it is given by

$$\frac{\partial}{\partial t} p(x,t) = - \frac{\partial}{\partial x}[\mu(x,t)p(x,t)] + \frac{\partial^2}{\partial x^2}[D(x,t)p(x,t)]$$

where $$p(x,t)$$ is the probability density of the SDE at time $$t$$ and $$x$$ and $$D(x,t) = \frac{\sigma^2(X_t,t)}{2}$$ is defined as the diffusion coefficient.
{:.lead}

To emphasise that there is a separate probability density for each time step, we will sometimes write the probability density $$p(x,t)$$ as $$p_t(x)$$ instead, where $$x$$ is the value of the SDE at time $$t$$. The FPE describes how this probability density evolves over time.

We will first derive the FPE for the special case of Brownian motion, then derive this general formula here and then look at the FPE for some common SDEs.

For completeness, the FPE for a general SDE of the form $$dX_t = \mu(X_t, t)dt + \sigma(X_t, t)dW_t$$ is given by

$$\partial_t p(x, t) = - \sum_{i=1}^d \partial_{x_i}[\mu_i(xi,t)p(x,t)] + \sum_{i,j=1}^N \partial_{x_i,x_j}[\sigma \sigma_{ij}(x,t)p(x,t)]$$


### 1.1 FPE for Brownian Motion

Let's start with the special case of Brownian motion, a stochastic process we discussed in the first lecture. For generality, let us denote the stochastic process as $$X_t$$, i.e. setting $$X_t = B_t$$ where $$B_t$$ is the Brownian motion.

Our SDE for Brownian motion is therefore (surprise, surprise) given by $$dX_t = dB_t$$.

Let us look at a twice continously differentiable, arbitrary function $$f(X_t)$$ with compact support and apply Ito's lemma to it. We get 

$$
\begin{align}
df(X_t) &= \partial_t f(X_t) dt + \partial_x f(X_t) dX_t + \frac{1}{2} \partial_{xx} f(X_t) (dX_t)^2 \\
        &= \partial_x f(X_t) dB_t + \frac{1}{2} \partial_{xx} f(X_t) dt \\
\mathbb{E}[df(X_t)] &= \mathbb{E}[\partial_x f(X_t) dB_t + \frac{1}{2} \partial_{xx} f(X_t) dt] \\
                    &= \mathbb{E}[\partial_x f(X_t) dB_t] + \frac{1}{2} \partial_{xx} f(X_t) dt \hspace{10px} \mid \mathbb{E}[dB_t] = 0\\
                    &= \frac{1}{2} \mathbb{E}[\partial_{xx} f(X_t)] dt \hspace{10px} \mid use dom. convergence theorem\\
\frac{d}{dt} \mathbb{E}[f(X_t)] &= \frac{1}{2} \mathbb{E}[\partial_{xx} f(X_t)] \hspace{10px} \mid rewrite \mathbb{E} and write \partial_{xx} f(x) = f_{xx}(x)\\
\frac{d}{dt} \int_{-\infty}^{\infty} f(x) p(x,t) dx &= \frac{1}{2} \int_{-\infty}^{\infty} f_{xx}(x) p(x,t) dx \hspace{10px} \mid integrate RHS by parts\\
\frac{d}{dt} \int_{-\infty}^{\infty} f(x) p(x,t) dx &= \frac{1}{2} [f_{xx}(x)p(x,t)\mid_{x=-\infty}^{x=\infty} - \int_{-\infty}^{\infty} f_x(x)\frac{\partial p(x,t)}{\partial x}dx] \hspace{10px} \mid first term=0 due to compact support\\
\frac{d}{dt} \int_{-\infty}^{\infty} f(x) p(x,t) dx &= - \frac{1}{2} \int_{-\infty}^{\infty} f_x(x)\frac{\partial p(x,t)}{\partial x}dx \hspace{10px} \mid integrate RHS by parts again\\
\frac{d}{dt} \int_{-\infty}^{\infty} f(x) p(x,t) dx &= - \frac{1}{2} [f_{x}(x)\frac{\partial p(x,t)}{\partial x}\mid_{x=-\infty}^{x=\infty} - \int_{-\infty}^{\infty} f(x)\frac{\partial^2 p(x,t)}{\partial x^2}dx] \hspace{10px} \mid first term=0 due to compact support\\
\frac{d}{dt} \int_{-\infty}^{\infty} f(x) p(x,t) dx &= \frac{1}{2} \int_{-\infty}^{\infty} f(x)\frac{\partial^2 p(x,t)}{\partial x^2}dx \hspace{10px} \mid \text{pull der. inside integral}\\
\int_{-\infty}^{\infty} f(x) \frac{\partial p(x,t)}{\partial t}  dx &= \frac{1}{2} \int_{-\infty}^{\infty} f(x)\frac{\partial^2 p(x,t)}{\partial x^2}dx \hspace{10px} \mid \text{regroup terms}\\
\int_{-\infty}^{\infty} f(x) \frac{\partial p(x,t)}{\partial t} - \frac{1}{2} \frac{\partial^2 p(x,t)}{\partial x^2} f(x) dx &= 0 \hspace{10px} \mid \text{f is arbitrary}\\
\frac{\partial p(x,t)}{\partial t} - \frac{1}{2} \frac{\partial^2 p(x,t)}{\partial x^2} &= 0\\
\end{align}
$$

### 1.2 FPE for General SDEs

### 1.3 FPE for GBM

### 1.4 FPE for OU

## 2. Time Reversal - Nelson's Duality Formula

[Anderson, 1982](https://www.sciencedirect.com/science/article/pii/0304414982900515)

### 2.1 A discrete time "heuristic" sketch

### 2.2 Time Reversal in score-based models


### 2.4 Usage of time reversal in practice
[Score matching](https://jmlr.org/papers/volume6/hyvarinen05a/hyvarinen05a.pdf)

[Thread about Hyvarinen papers](https://twitter.com/volokuleshov/status/1739456111827390592)


## 3. Score-based modelling via SDEs

## 4. Conditioning - Doob's h-transform

### 4.1 Example for pinned Brownian motion

## 5. Conditioning in score-based models

## 6. Probability flow ODE

## 7. Flow Matching
